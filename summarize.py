from openai import OpenAI
from config import OPENAI_API_KEY
import re
from datetime import datetime
from email.utils import parsedate_to_datetime

client = OpenAI(api_key=OPENAI_API_KEY)

def _normalize_date(date_str: str) -> str:
    """
    æŠŠå„ç¨®æ—¥æœŸæ ¼å¼çµ±ä¸€æˆ YYYY/MM/DD,ä¸¦ç§»é™¤æ™‚é–“ã€‚
    æ”¯æ´ï¼š
    - 2026-01-03 01:53:26
    - 2026-01-03
    - Fri, 09 Jan 2026 06:06:48 GMT (RSS)
    - 2026/01/03
    """
    s = (date_str or "").strip()

    # 1) å…ˆæŠ“ ISO / slash æ ¼å¼
    m = re.search(r"(\d{4})[-/](\d{2})[-/](\d{2})", s)
    if m:
        return f"{m.group(1)}/{m.group(2)}/{m.group(3)}"

    # 2) RSS / RFC822 ä¾‹ï¼šFri, 09 Jan 2026 06:06:48 GMT
    try:
        dt = parsedate_to_datetime(s)
        return dt.strftime("%Y/%m/%d")
    except Exception:
        pass

    # 3) å…¶ä»–å¸¸è¦‹æ ¼å¼ï¼ˆä¿åº•ï¼‰
    fmts = [
        "%Y-%m-%d %H:%M:%S",
        "%Y-%m-%dT%H:%M:%S",
        "%a, %d %b %Y %H:%M:%S %Z",
        "%a, %d %b %Y %H:%M:%S %z",
    ]
    for fmt in fmts:
        try:
            dt = datetime.strptime(s, fmt)
            return dt.strftime("%Y/%m/%d")
        except Exception:
            continue

    # 4) ç„¡æ³•è§£æå°±åŸæ¨£å›å‚³ï¼ˆä½†è‡³å°‘ä¸æœƒå™´éŒ¯ï¼‰
    return s

SYSTEM_PROMPT = (
    "ä½ æ˜¯ä¸€ä½ä¸­ç«‹ã€èª å¯¦ã€å°ˆæ¥­çš„å°ç£ä¸­æ–‡è²¡ç¶“åŠ©ç†ã€‚"
    "ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šæœ€æ–°è³‡æ–™æä¾›å®¢è§€åˆ†æï¼Œç„¡è«–ä½¿ç”¨è€…çš„æå•èªæ°£æ˜¯æ­£é¢æˆ–è² é¢ï¼Œéƒ½å¿…é ˆä¾æ“šè³‡æ–™èª å¯¦å›è¦†ã€‚"
    "è‹¥è³‡æ–™é¡¯ç¤ºè¡¨ç¾ä¸ä½³æˆ–ä¸‹è¡Œé¢¨éšªï¼Œå¿…é ˆæ˜ç¢ºæŒ‡å‡ºã€‚"
    "ä¸å¾—å®‰æ’«æˆ–æ¨¡ç³Šå›ç­”ï¼Œä¹Ÿä¸å¾—å¼·è¡Œæ‰¾å‡ºæ¨‚è§€ç†ç”±ã€‚"
    "è«‹ä¿æŒåˆ†æèªæ°£ï¼Œé‡é»åœ¨äº‹å¯¦èˆ‡è³‡æ–™æœ¬èº«ã€‚"
    "æœ€å¾Œä¸€è¡Œä¸€å¾‹é™„ä¸Šã€Œï¼ˆåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ï¼‰ã€"
)

def summarize_with_gpt(user_query: str, context: str):
    """
    ä½¿ç”¨ GPT å°ä½¿ç”¨è€…å®Œæ•´å•é¡Œé€²è¡Œåˆ†æèˆ‡æ‘˜è¦ï¼Œçµåˆ RAG contextã€‚
    """

    # === è‹¥ RAG å›å‚³æ‰¾ä¸åˆ°å…¬å¸åç¨±çš„è¨Šæ¯ï¼Œç›´æ¥å›è¦†å›ºå®šæ¨¡æ¿ ===
    if context.startswith("æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°èˆ‡") or "æŸ¥ç„¡å…¬å¸" in context:
        print("[GPT/Skip] ğŸš« è·³é GPT å‘¼å«ï¼ˆå› æœªè¾¨è­˜å‡ºå…¬å¸åç¨±ï¼‰")
        return f"æŠ±æ­‰ï¼Œæ ¹æ“šç›®å‰çš„è³‡æ–™ï¼Œç„¡æ³•æ‰¾åˆ°èˆ‡ã€Œ{user_query}ã€ç›¸é—œçš„å…¬å¸æˆ–å…¶è‚¡åƒ¹è³‡è¨Šã€‚\nè«‹ç¢ºèªå…¬å¸åç¨±æˆ–ä»£è™Ÿæ˜¯å¦æ­£ç¢ºï¼Œä»¥ä¾¿æä¾›æ›´æº–ç¢ºçš„åˆ†æã€‚\n\nï¼ˆåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ï¼‰"

    prompt = f"""
ä½¿ç”¨è€…çš„åŸå§‹å•é¡Œå¦‚ä¸‹ï¼š
ã€Œ{user_query}ã€

ä»¥ä¸‹æ˜¯ä½ å¯åƒè€ƒçš„æœ€æ–°æª¢ç´¢è³‡æ–™ï¼ˆè‚¡åƒ¹èˆ‡æ–°èï¼‰ï¼š
---
{context}
---

è«‹æ ¹æ“šä½¿ç”¨è€…çš„å•é¡Œæ„åœ–èˆ‡ä¸Šè¿°è³‡æ–™ï¼Œç”Ÿæˆæœ‰æ¢ç†çš„ä¸­æ–‡å›è¦†ã€‚

âœ… è«‹éµå®ˆä»¥ä¸‹åŸå‰‡ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š

ã€ç«‹å ´åˆ¤æ–·è¦å‰‡ï¼ˆå¿…é ˆéµå®ˆï¼‰ã€‘

é‡è¦ï¼š

1. ä½¿ç”¨è€…å•ã€Œç‚ºä»€éº¼è·Œ/æ¼²ã€åªæ˜¯è©¢å•åŸå› èˆ‡è„ˆçµ¡ï¼Œä¸æ˜¯ç«‹å ´è­‰æ“šã€‚
2. ç«‹å ´ï¼ˆåå¤š/åç©º/ä¸­æ€§ï¼‰åªèƒ½ä¾æ“šæœ¬æ¬¡æä¾›çš„ contextï¼ˆè‚¡åƒ¹å‹•æ…‹ã€æ–°èæ‘˜è¦ã€å…¨æ–‡æ‘˜éŒ„ï¼‰åˆ¤æ–·ï¼›ä¸å¾—å› ä½¿ç”¨è€…ç”¨è©ç›´æ¥ç¿»å¤š/ç¿»ç©ºã€‚
3. å³ä½¿ä½¿ç”¨è€…å•ã€Œæœƒæ¼²å—/æœƒè·Œå—ã€é€™é¡åƒ¹æ ¼é æ¸¬å¼å•é¡Œï¼Œä½ ä¹Ÿ**å¿…é ˆè¼¸å‡ºæŠ•è³‡ç«‹å ´**ï¼ˆåå¤š/åç©º/ä¸­æ€§ï¼‰ã€‚ä½ ä¸èƒ½ä¿è­‰çŸ­æœŸåƒ¹æ ¼ï¼Œä½†ç«‹å ´ä»ä»¥è­‰æ“šæ¨å°çš„ã€Œæœªä¾†å±•æœ›ã€ç‚ºæº–ï¼›æ­¤é¡å•é¡Œæ‡‰å„ªå…ˆã€Œé™ä½ä¿¡å¿ƒã€æ”¹ç”¨æƒ…å¢ƒå¼æ¢ä»¶æè¿°ã€ï¼Œè€Œä¸æ˜¯å› å•æ³•æ”¹æˆä¸­æ€§ã€‚
4. è‹¥è­‰æ“šä¸è¶³æˆ–æ­£è² çŸ›ç›¾ä¸”ç„¡æ³•é‡æ¸…ï¼Œç«‹å ´å¿…é ˆé¸ä¸­æ€§ï¼ˆä¸¦é™ä½ä¿¡å¿ƒï¼‰ã€‚

å®šç¾©ï¼ˆè«‹ç”¨ã€Œæœªä¾†å±•æœ›ã€è€Œéã€Œä»Šå¤©æ¼²è·Œã€ä¾†åˆ¤æ–·ç«‹å ´ï¼‰ï¼š

* æ­£å‘è­‰æ“šï¼šèƒ½æ”¯æŒåŸºæœ¬é¢/å±•æœ›æ”¹å–„ã€éœ€æ±‚ä¸Šä¿®ã€åˆ©å¤šè½åœ°ã€æ³•äººæ­£å‘ç­‰ï¼ˆéœ€å¼•ç”¨ï¼‰ã€‚
* è² å‘è­‰æ“šï¼šèƒ½æ”¯æŒåŸºæœ¬é¢/å±•æœ›è½‰å¼±ã€ä¸‹ä¿®/åˆ©ç©ºè½åœ°ã€ç›£ç®¡/è¨´è¨Ÿ/äº‹æ•…ã€éœ€æ±‚ä¸‹æ»‘ç­‰ï¼ˆéœ€å¼•ç”¨ï¼‰ã€‚
* å…¨æ–‡æ‘˜éŒ„å±¬æ–¼ã€Œé«˜æ¬Šé‡è­‰æ“šã€ï¼›æ–°èæ¨™é¡Œ/çŸ­æ‘˜è¦å±¬æ–¼ã€Œä¸­æ¬Šé‡è­‰æ“šã€ã€‚è‹¥åƒ…æœ‰æ¨™é¡Œç´šè­‰æ“šï¼Œå…è¨±ä¸‹çµè«–ä½†å¿…é ˆé™ä½ä¿¡å¿ƒã€èªæ°£ä¿å®ˆã€‚

åˆ¤æ–·é–€æª»ï¼š

* åå¤šï¼š
  éœ€è‡³å°‘ 2 é»ã€Œæ­£å‘è­‰æ“šã€ï¼Œä¸”æ²’æœ‰è¶³ä»¥ç›´æ¥åé§çš„é‡å¤§è² å‘è­‰æ“šã€‚
  *è‹¥å­˜åœ¨å…¨æ–‡æ‘˜éŒ„ï¼šè‡³å°‘ 1 é»æ­£å‘è­‰æ“šæ‡‰ä¾†è‡ªå…¨æ–‡æ‘˜éŒ„ï¼ˆé«˜æ¬Šé‡ï¼‰ã€‚*
  *è‹¥å…¨æ–‡æ‘˜éŒ„=0ï¼šä»å¯åå¤šï¼Œä½†å¿…é ˆåŒæ™‚æ»¿è¶³ï¼š*
  (i) è‡³å°‘ 2 é»æ­£å‘è­‰æ“šä¾†è‡ªã€Œä¸åŒä¾†æº/ä¸åŒæ–°èæ¢ç›®ã€
  (ii) å¿…é ˆæ˜ç¢ºä¸‹èª¿ä¿¡å¿ƒï¼Œä¸¦ç”¨ä¿å®ˆæªè¾­ï¼ˆä¾‹å¦‚ã€Œåå‘ã€ã€Œå¯èƒ½ã€ã€Œä»éœ€è§€å¯Ÿã€ï¼‰

* åç©ºï¼š
  éœ€è‡³å°‘ 2 é»ã€Œè² å‘è­‰æ“šã€ï¼Œä¸”æ²’æœ‰è¶³ä»¥ç›´æ¥åé§çš„é‡å¤§æ­£å‘è­‰æ“šã€‚
  *è‹¥å­˜åœ¨å…¨æ–‡æ‘˜éŒ„ï¼šè‡³å°‘ 1 é»è² å‘è­‰æ“šæ‡‰ä¾†è‡ªå…¨æ–‡æ‘˜éŒ„ï¼ˆé«˜æ¬Šé‡ï¼‰ã€‚*
  *è‹¥å…¨æ–‡æ‘˜éŒ„=0ï¼šä»å¯åç©ºï¼Œä½†å¿…é ˆåŒæ™‚æ»¿è¶³ï¼š*
  (i) è‡³å°‘ 2 é»è² å‘è­‰æ“šä¾†è‡ªã€Œä¸åŒä¾†æº/ä¸åŒæ–°èæ¢ç›®ã€
  (ii) å¿…é ˆæ˜ç¢ºä¸‹èª¿ä¿¡å¿ƒï¼Œä¸¦ç”¨ä¿å®ˆæªè¾­ï¼ˆä¾‹å¦‚ã€Œåå‘ã€ã€Œå¯èƒ½ã€ã€Œä»éœ€è§€å¯Ÿã€)

* ä¸­æ€§ï¼ˆè§€æœ›ï¼‰ï¼š
  åªè¦ç¬¦åˆä»¥ä¸‹ä»»ä¸€æ¢ä»¶ï¼Œå°±å¿…é ˆé¸ä¸­æ€§ï¼š
  (a) è­‰æ“šä¸è¶³ï¼šåªæœ‰ 0â€“1 é»é›¶æ•£è­‰æ“šï¼Œæˆ–å¤šç‚ºå–®ä¸€ä¾†æºçš„æ¨™é¡Œç´šè³‡è¨Šï¼Œç„¡æ³•å½¢æˆæ–¹å‘
  (b) æ­£è² è­‰æ“šåŒæ™‚å­˜åœ¨ä¸”äº’ç›¸ç‰´è§¸ï¼Œä¸”ç„¡å…¨æ–‡æ‘˜éŒ„å¯é‡æ¸…ï¼ˆæˆ–é‡æ¸…å¾Œä»ç„¡æ³•åˆ¤å®šä¸»å°æ–¹å‘ï¼‰
  (c) ä½¿ç”¨è€…å•é¡Œéœ€è¦é—œéµæ•¸å­—/å®˜æ–¹èªªæ³•ï¼Œä½† context ç¼ºå¤±æˆ–ä¸å¯é ï¼Œå°è‡´æ–¹å‘ç„¡æ³•é©—è­‰
  (d) ç„¡æ³•æå‡ºã€Œè‡³å°‘ 2 é»åŒå‘è­‰æ“šã€ä¾†æ”¯æŒä»»ä½•å±•æœ›æ–¹å‘ï¼ˆå³ä½¿èƒ½è§£é‡‹äº‹ä»¶ï¼Œä¹Ÿä¸è¶³ä»¥æ”¯æŒåå¤š/åç©ºï¼‰

è£œå……ï¼š

* å›ç­”ã€ŒåŸå› ã€å¯ä»¥æ›´è²¼è¿‘ä½¿ç”¨è€…å•æ³•ï¼ˆè·Œ/æ¼²/æœƒæ¼²å—ï¼‰ï¼Œä½†ã€Œç«‹å ´ã€å¿…é ˆä»¥å±•æœ›èˆ‡è­‰æ“šå¼·åº¦æ±ºå®šï¼›å°ã€Œæœƒæ¼²å—/æœƒè·Œå—ã€æ‡‰ä»¥ã€Œæ¢ä»¶å¼æƒ…å¢ƒã€å›ç­”ä¸¦é™ä½ä¿¡å¿ƒï¼Œè€Œéçµ¦å‡ºä¿è­‰ã€‚
* æ‰€æœ‰è­‰æ“šé»éƒ½è¦é™„ä¸Šå¼•ç”¨ç·¨è™Ÿ [n]ï¼›ä¸å¯æé€ æœªå‡ºç¾åœ¨ context çš„è³‡è¨Šã€‚
* è‹¥ç«‹å ´ç‚ºåå¤š/åç©ºä½†ä¿¡å¿ƒåä½ï¼Œå¿…é ˆåœ¨æ–‡ä¸­æ˜ç¢ºèªªæ˜ã€Œå“ªä¸€å¡Šè­‰æ“šä¸è¶³ã€ä»¥åŠã€Œæ¥ä¸‹ä¾†æ‡‰è§€å¯Ÿä»€éº¼ã€ã€‚


ã€ä¿¡å¿ƒåˆ¤æ–·è¦å‰‡ï¼ˆå¿…é ˆéµå®ˆï¼‰ã€‘

ä½ å¿…é ˆä¾æ“šã€Œè­‰æ“šå¼·åº¦ã€æ±ºå®šä¿¡å¿ƒï¼Œä¸”è¦ä¿å®ˆã€‚è­‰æ“šå¼·åº¦ç”±ä»¥ä¸‹å› ç´ æ§‹æˆï¼š

* ä¾†æºä¸€è‡´æ€§ï¼šåŒä¸€æ–¹å‘çš„è­‰æ“šæ˜¯å¦åœ¨å¤šå€‹ä¾†æºä¸­é‡è¤‡å‡ºç¾
* ä¾†æºç¨ç«‹æ€§ï¼šè‡³å°‘ä¾†è‡ª 2 å€‹ä¸åŒæ–°èæ¢ç›®ï¼ˆä¸åŒ URL/æ¨™é¡Œè¦–ç‚ºä¸åŒæ¢ç›®ï¼‰
* è­‰æ“šæ¬Šé‡ï¼šå…¨æ–‡æ‘˜éŒ„ï¼ˆé«˜ï¼‰ > æ–°èæ‘˜è¦/æ¨™é¡Œï¼ˆä¸­ï¼‰
* è¡çªç¨‹åº¦ï¼šæ­£è² è­‰æ“šæ˜¯å¦äº’ç›¸ç‰´è§¸ä¸”ç„¡æ³•é‡æ¸…
* ç¼ºå¤±ç¨‹åº¦ï¼šæ˜¯å¦ç¼ºé—œéµæ•¸å­—/å®˜æ–¹èªªæ³•å°è‡´ç„¡æ³•é©—è­‰

ç­‰ç´šå®šç¾©ï¼š

* é«˜ï¼ˆå°‘è¦‹ï¼Œéœ€å¾ˆæ‰å¯¦ï¼‰ï¼š
  åŒä¸€æ–¹å‘è‡³å°‘æœ‰ã€Œ2 å€‹ä»¥ä¸Šã€ç¨ç«‹ä¾†æºæ”¯æŒï¼Œä¸”ã€Œè‡³å°‘ 1 å€‹ä¾†æºã€å…·æœ‰å…¨æ–‡æ‘˜éŒ„å¯å¼•ç”¨ï¼›
  åŒæ™‚ï¼Œæ²’æœ‰åŒç­‰å¼·åº¦çš„åå‘è­‰æ“šèƒ½ç›´æ¥æ¨ç¿»ã€‚
  å…¸å‹æƒ…å¢ƒï¼šå…¨æ–‡æ‘˜éŒ„æ˜ç¢ºæ”¯æŒé—œéµäº‹ä»¶/èªªæ³• + å¦ä¸€ä¾†æºï¼ˆæ¨™é¡Œ/æ‘˜è¦æˆ–å¦ä¸€æ‘˜éŒ„ï¼‰åŒå‘ä½è­‰ã€‚

* ä¸­ï¼ˆå¸¸è¦‹ä¸Šé™ï¼Œä»éœ€å¯é©—è­‰ï¼‰ï¼š
  æ»¿è¶³ä¸‹åˆ—ä»»ä¸€å³å¯ï¼š
  (a) è‡³å°‘ 1 å€‹å…¨æ–‡æ‘˜éŒ„å¯å¼•ç”¨ï¼Œä¸”å¦æœ‰è‡³å°‘ 1 å€‹ä¾†æºæ¸…å–®åŒå‘æ”¯æŒï¼ˆå³ã€Œ1 æ‘˜éŒ„ + 1 ä½è­‰ã€ï¼‰
  (b) ç„¡å…¨æ–‡æ‘˜éŒ„ï¼Œä½†åŒä¸€ä¸»é¡Œ/äº‹ä»¶åœ¨ã€Œ3 å€‹ä»¥ä¸Šã€ç¨ç«‹ä¾†æºä¸­é«˜åº¦ä¸€è‡´ï¼Œä¸”åå‘è­‰æ“šå¾ˆå¼±æˆ–ä¸å­˜åœ¨
  æ³¨æ„ï¼šè‹¥åªæœ‰ 1â€“2 å‰‡æ¨™é¡Œç´šè³‡è¨Šï¼Œé€šå¸¸ä¸å¯çµ¦ä¸­ã€‚

* ä½ï¼ˆé è¨­å¸¸è¦‹ï¼‰ï¼š
  åªè¦ç¬¦åˆä»¥ä¸‹ä»»ä¸€æ¢ä»¶ï¼Œå°±é¸ä½ï¼š
  (a) å…¨æ–‡æ‘˜éŒ„ = 0ï¼Œä¸”åŒå‘ä¾†æºå°‘æ–¼ 3ï¼ˆå¤šç‚ºæ¨™é¡Œ/æ‘˜è¦æ¨è«–ï¼‰
  (b) æ­£è² è­‰æ“šåŒæ™‚å­˜åœ¨ä¸”äº’ç›¸ç‰´è§¸ï¼Œä¸”ç„¡å…¨æ–‡æ‘˜éŒ„å¯é‡æ¸…
  (c) ä½¿ç”¨è€…å•é¡Œéœ€è¦é—œéµæ•¸å­—/å®˜æ–¹èªªæ³•ï¼Œä½† context ç¼ºå¤±æˆ–ä¸å¯é 
  (d) èƒ½è§£é‡‹ã€Œäº‹ä»¶åŸå› ã€ï¼Œä½†ä¸è¶³ä»¥æ”¯æŒã€Œå±•æœ›/è¶¨å‹¢ã€çµè«–ï¼ˆæ­¤æ™‚ç«‹å ´å¯ä¸­æ€§ï¼Œä¿¡å¿ƒéœ€ä½ï¼‰

è£œå……ï¼š

* ã€Œé«˜ã€æ‡‰å¾ˆå°‘å‡ºç¾ï¼›è‹¥ä½ ä¸ç¢ºå®šï¼Œé¸ã€Œä¸­ã€æˆ–ã€Œä½ã€ã€‚
* ç„¡å…¨æ–‡æ‘˜éŒ„æ™‚ä¸ç­‰æ–¼æ°¸é ä½ï¼šè‹¥åŒä¸€äº‹ä»¶åœ¨ 3+ ç¨ç«‹ä¾†æºé«˜åº¦ä¸€è‡´ï¼Œå¯çµ¦ã€Œä¸­ã€ï¼Œä½†èªæ°£éœ€ä¿å®ˆã€‚
* ä¿¡å¿ƒåªè©•ä¼°ã€Œæœ¬æ¬¡ context èƒ½æ”¯æŒçš„ç¨‹åº¦ã€ï¼Œä¸å¾—ä½¿ç”¨å¤–éƒ¨å¸¸è­˜è£œè¶³ã€‚


ã€è¼¸å‡ºé¢¨æ ¼ï¼ˆè®“å›ç­”æ›´åƒé‡‘èåŠ©ç†ã€ä½†ä»å¯é©—è­‰ï¼‰ã€‘
5 ä¸è¦ä¸€ç›´é‡è¤‡ã€Œä¸ç¢ºå®š/çŸ›ç›¾ã€é€™é¡æé†’ï¼š
   - åªæœ‰åœ¨ã€ŒçœŸçš„ç¼ºè³‡æ–™ã€æˆ–ã€Œå¼•ç”¨ä¾†æºå½¼æ­¤äº’ç›¸æ‰“æ¶ã€æ™‚ï¼Œæ‰å¯«è³‡æ–™ä¸è¶³æˆ–æŒ‡å‡ºè¡çªã€‚
   - å…¶ä»–æƒ…æ³è«‹ç”¨ã€Œç›®å‰è³‡æ–™é¡¯ç¤ºâ€¦ã€â†’ã€Œå› æ­¤â€¦ã€çš„æ”¶æ–‚å¯«æ³•ï¼Œç›´æ¥çµ¦ä½¿ç”¨è€…å¯ç”¨çš„æ•´ç†ã€‚

6 ä¸æä¾›æ˜ç¢ºè²·è³£å»ºè­°ã€ç›®æ¨™åƒ¹æˆ–é€²å‡ºå ´é»ï¼›åƒ…åšè³‡è¨Šæ•´ç†ã€å¯èƒ½åŸå› ï¼ˆå¿…è¦æ™‚æ¨™è¨»ä¸€èˆ¬æƒ…æ³ï¼‰èˆ‡é¢¨éšªæé†’ã€‚

ã€è¼¸å‡ºæ ¼å¼ï¼ˆå›ºå®šï¼‰ã€‘

âœ…ã€ä¸€å¥è©±çµè«–ã€‘ï¼š
- ç”¨ä¸€å¥è©±å›ç­”ã€ŒåŸå› /é‡é»ã€
- è‹¥èƒ½å½¢æˆåˆ¤æ–·ï¼šç”¨ä¸€å¥è©±å›ç­”ä½¿ç”¨è€…å•é¡Œï¼Œä¸¦çµ¦ã€Œç«‹å ´ï¼šåå¤š/ä¸­æ€§/åç©ºã€+ã€Œä¿¡å¿ƒï¼šé«˜/ä¸­/ä½ã€ã€‚(åªä¾æ“š context)
- è‹¥ç„¡æ³•å½¢æˆåˆ¤æ–·ï¼šè«‹ç›´æ¥å¯«ã€Œè³‡æ–™ä¸è¶³ï¼Œç„¡æ³•åˆ¤æ–·ã€ï¼Œä¸¦èªªæ˜ç¼ºå°‘ä»€éº¼ï¼›æ­¤æ™‚ä¸å¿…ç¡¬çµ¦ç«‹å ´æˆ–å¼•ç”¨ã€‚

ğŸ“ˆã€è‚¡åƒ¹å‹•æ…‹ã€‘ï¼š
- æœ¬æ®µåªä½¿ç”¨ context ä¸­çš„ã€Œ[è‚¡åƒ¹è³‡è¨Š]ã€æ¬„ä½ï¼Œä¸éœ€è¦ä¹Ÿä¸å…è¨±ä½¿ç”¨æ–°èå¼•ç”¨ç·¨è™Ÿ [1]..[8]ã€‚
- è«‹ä¾ [è‚¡åƒ¹è³‡è¨Š] çš„æ•¸å€¼è¼¸å‡º 1 è¡Œï¼Œæ ¼å¼å›ºå®šç‚ºï¼š
  - å…¬å¸åï¼ˆè‚¡ç¥¨ä»£è™Ÿï¼‰ç›®å‰è‚¡åƒ¹ç‚ºç¾åƒ¹å…ƒï¼Œè¼ƒå‰ä¸€æ—¥ä¸Šæ¼²/ä¸‹è·Œæ¼²è·Œå…ƒï¼Œæ¼²å¹…/è·Œå¹…ç‚ºæ¼²è·Œå¹…%ã€‚

ğŸ“Œã€è­‰æ“šé‡é»ã€‘ï¼š
- 3-6 é»æ¢åˆ—ï¼Œæ¯é»ä¸€å¥è©±ï¼Œæ¯é»å¥å°¾å¿…é ˆå¼•ç”¨ï¼Œä¾‹å¦‚ï¼š[1] æˆ– [2][5]

âš ï¸ã€é¢¨éšªèˆ‡éœ€è¦è¿½è¹¤çš„é»ã€‘ï¼š
- 2-4 é»æ¢åˆ—ï¼ˆä¾‹å¦‚ï¼šç¼ºå°‘å…§æ–‡/ç¼ºå°‘æ•¸å­—/äº‹ä»¶å°šæœªç¢ºèª/åˆ©å¤šåˆ©ç©ºçš„æ¢ä»¶ï¼‰ã€‚
  èƒ½å¼•ç”¨å°±å¼•ç”¨ï¼›ä¸èƒ½å¼•ç”¨å°±ç›´æ¥èªªè³‡æ–™ä¸è¶³ã€‚



"""
    try:
        resp = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": prompt},
            ],
            temperature=0.4,  # é™ä½æº«åº¦ï¼Œè®“èªæ°£æ›´ç©©é‡ã€å°‘å®‰æ’«èª
            max_tokens=1000,
        )

        # âœ… æ–°å¢é€™æ®µä¾†é¡¯ç¤º Token ç”¨é‡
        usage = resp.usage
        print(f"LOG: Token ä½¿ç”¨æƒ…æ³ -> prompt={usage.prompt_tokens}, completion={usage.completion_tokens}, total={usage.total_tokens}")
        cost_usd = usage.prompt_tokens * 0.00015 / 1000 + usage.completion_tokens * 0.0006 / 1000
        cost_twd = cost_usd * 32
        print(f"LOG: é ä¼°æˆæœ¬ â‰ˆ {cost_twd:.4f} å…ƒå°å¹£\n")


        def _extract_sources_map(context: str) -> dict:
            """
            å¾ context ä¸­æŠ“å‡ºæ–°èä¾†æºæ¸…å–®çš„æ¯ä¸€è¡Œï¼š
            [1] æ¨™é¡Œ | ä¾†æº | æ—¥æœŸ | url
            å›å‚³ dict: { "1": "æ¨™é¡Œ | ä¾†æº | æ—¥æœŸ", ... }  (ä¸å« url)
            """
            src_map = {}
            # æ‰¾æ‰€æœ‰å½¢å¦‚ï¼š[n] ... çš„è¡Œ
            for m in re.finditer(r"^\[(\d+)\]\s*(.+)$", context, flags=re.MULTILINE):
                idx = m.group(1)
                line = m.group(2).strip()

                # ä½ çš„ä¾†æºè¡Œæ˜¯ï¼šæ¨™é¡Œ | source | date 
                parts = [p.strip() for p in line.split("|")]
                if len(parts) >= 4:
                    title = parts[0]
                    source = parts[1]
                    date_raw = parts[2]

                    # (å¯é¸) å»æ‰ title å°¾å·´é‡è¤‡çš„ã€Œ- ä¾†æºã€
                    if " - " in title:
                        tail = title.rsplit(" - ", 1)[-1].strip()
                        if tail == source:
                            title = title.rsplit(" - ", 1)[0].strip()

                    date_norm = _normalize_date(date_raw)

                    # æœ€çµ‚åªè¼¸å‡ºï¼šæ¨™é¡Œ | ä¾†æº | YYYY/MM/DD
                    src_map[idx] = f"{title} | {source} | {date_norm}"
                else:
                    continue  # ä¸æ˜¯ä¾†æºè¡Œå°±è·³é


            return src_map


        def _extract_used_citations(text: str) -> list:
            """
            å¾æ¨¡å‹è¼¸å‡ºæŠ“å‡ºæ‰€æœ‰å¼•ç”¨ç·¨è™Ÿ [n]
            å›å‚³å»é‡å¾Œã€ä¾æ•¸å­—æ’åºçš„ list[str]
            """
            ids = re.findall(r"\[(\d+)\]", text)
            ids = sorted(set(ids), key=lambda x: int(x))
            return ids


        def _remove_existing_reference_block(text: str) -> str:
            """
            ç§»é™¤æ¨¡å‹è‡ªå·±ç”¢ç”Ÿçš„ ğŸ”—ã€å¼•ç”¨ä¾†æºã€‘æ®µè½ï¼ˆé¿å…é‡è¤‡/æ¼åˆ—ï¼‰
            """
            # å¾ ğŸ”—ã€å¼•ç”¨ä¾†æºã€‘ é–‹å§‹åˆªåˆ°æ–‡æœ«ï¼ˆæˆ–ä¸‹ä¸€å€‹æ®µè½ï¼‰ï¼Œé€™è£¡ç°¡å–®åˆªåˆ°æ–‡æœ«æœ€ç©©
            return re.sub(r"\n*ğŸ”—ã€å¼•ç”¨ä¾†æºã€‘[\s\S]*$", "", text).rstrip()


        # ---- after receiving model output ----
        text = resp.choices[0].message.content.strip()

        # 1) æŠ“å‡ºæ­£æ–‡ç”¨åˆ°çš„å¼•ç”¨ç·¨è™Ÿ
        used_ids = _extract_used_citations(text)

        # 2) å¾ context æŠ“å‡ºæ¯å€‹ç·¨è™Ÿå°æ‡‰çš„ä¾†æºè¡Œï¼ˆä¸å« urlï¼‰
        src_map = _extract_sources_map(context)

        # 3) çµ„è£å¼•ç”¨ä¾†æºæ®µè½ï¼ˆåªåˆ—å¯¦éš›ç”¨åˆ°çš„ï¼‰
        lines = []
        for cid in used_ids:
            if cid in src_map:
                lines.append(f"- [{cid}] {src_map[cid]}")
            else:
                # è‹¥æ¨¡å‹å¼•ç”¨åˆ° context æ²’æœ‰çš„ç·¨è™Ÿï¼Œé€™è£¡é¸æ“‡ä¸åˆ—å‡ºä¸¦å° logï¼ˆä¹Ÿå¯ç›´æ¥å¿½ç•¥ï¼‰
                print(f"[WARN] citation [{cid}] not found in context source list")

        ref_block = "ğŸ”—ã€å¼•ç”¨ä¾†æºã€‘ï¼š\n" + ("\n".join(lines) if lines else "-ï¼ˆæœ¬æ¬¡æœªä½¿ç”¨æ–°èå¼•ç”¨ï¼‰")

        # 4) ç§»é™¤æ¨¡å‹åŸæœ¬å¼•ç”¨ä¾†æºæ®µè½ï¼Œæ›æˆä½ ç¨‹å¼ç”Ÿæˆçš„
        text = _remove_existing_reference_block(text)
        text = text.rstrip() + "\n\n" + ref_block

        # 5) å…è²¬ä¿åº•ï¼ˆé¿å…æ¼æ‰æˆ–é‡è¤‡ï¼‰
        disclaimer = "ï¼ˆåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°ï¼‰"
        text = text.replace(disclaimer + "\n" + disclaimer, disclaimer)
        if not text.endswith(disclaimer):
            text = text.rstrip() + "\n\n" + disclaimer

        return text

    except Exception as e:
        print(f"LOG: OpenAI API å‘¼å«å¤±æ•—: {e}")
        return "æŠ±æ­‰ï¼ŒAI åˆ†ææ™‚ç™¼ç”Ÿå•é¡Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"